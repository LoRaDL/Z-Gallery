{% extends "layout.html" %}
{% block content %}

<!-- SVG å®¹å™¨ï¼šç”¨äºå­˜æ”¾åŠ¨æ€ç”Ÿæˆçš„è¶…æ¤­åœ† clip-path -->
<svg width="0" height="0" style="position: absolute;" id="squircle-defs">
    <defs id="squircle-clips">
        <!-- è¶…æ¤­åœ† clip-path ä¼šé€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        <!-- æ¯ä¸ªå¡ç‰‡ä½¿ç”¨å›ºå®š 12px åŠå¾„ï¼Œé¿å…é•¿æ–¹å½¢å˜å½¢ -->
    </defs>
</svg>

<div class="controls-container">
    <!-- Sort Group -->
    <span class="filter-label">Sort:</span>
    <a href="{{ url_for('gallery', **generate_url_params('sort', 'newest')) }}" class="{{ 'active' if current_sort == 'newest' }}">Newest</a>
    <a href="{{ url_for('gallery', **generate_url_params('sort', 'oldest')) }}" class="{{ 'active' if current_sort == 'oldest' }}">Oldest</a>
    <a href="{{ url_for('gallery', **generate_url_params('sort', 'latest_added')) }}" class="{{ 'active' if current_sort == 'latest_added' }}">Latest Added</a>
    <a href="{{ url_for('gallery', **generate_url_params('sort', 'rating')) }}" class="{{ 'active' if current_sort == 'rating' }}">Rating</a>

    <span class="separator">|</span>

    <!-- Classification Group -->
    <span class="filter-label">Class:</span>
    <a href="{{ url_for('gallery', **generate_url_params('classification_filter', 'unspecified')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'unspecified' }}">Unspecified</a>
    <a href="{{ url_for('gallery', **generate_url_params('classification_filter', 'sfw')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'sfw' }}">SFW</a>
    <a href="{{ url_for('gallery', **generate_url_params('classification_filter', 'mature')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'mature' }}">Mature</a>
    <a href="{{ url_for('gallery', **generate_url_params('classification_filter', 'nsfw')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'nsfw' }}">NSFW</a>

    <span class="separator">|</span>

    <!-- Category Group -->
    <span class="filter-label">Category:</span>
    <a href="{{ url_for('gallery', **generate_url_params('category', 'fanart_non_comic')) }}" class="{{ 'active' if current_filters.get('category') == 'fanart_non_comic' }}">Art</a>
    <a href="{{ url_for('gallery', **generate_url_params('category', 'fanart_comic')) }}" class="{{ 'active' if current_filters.get('category') == 'fanart_comic' }}">Comic</a>
    <a href="{{ url_for('gallery', **generate_url_params('category', 'real_photo')) }}" class="{{ 'active' if current_filters.get('category') == 'real_photo' }}">Photo</a>
    <a href="{{ url_for('gallery', **generate_url_params('category', 'other')) }}" class="{{ 'active' if current_filters.get('category') == 'other' }}">Other</a>

    <span class="separator">|</span>

    <!-- Rating Group -->
    <span class="filter-label">Rating:</span>
    <a href="{{ url_for('gallery', **generate_url_params('rating_filter', 'unrated')) }}" class="{{ 'active' if current_filters.get('rating_filter') == 'unrated' }}">Unrated</a>
    <a href="{{ url_for('gallery', **generate_url_params('rating_filter', '2_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '2_plus' }}">2â˜…+</a>
    <a href="{{ url_for('gallery', **generate_url_params('rating_filter', '5_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '5_plus' }}">5â˜…+</a>
    <a href="{{ url_for('gallery', **generate_url_params('rating_filter', '8_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '8_plus' }}">8â˜…+</a>
</div>

    {% if current_filters %}
    <div class="active-filters">
        <span>Active Filters:</span>
        <!-- FIX: Use the new helper function for removing filters -->
        {% for key, value in current_filters.items() %}
            {% if key == 'similar_to' %}
                <a href="{{ url_for('gallery', **generate_url_params(key, None)) }}" class="filter-pill">
                    Similar Images (Threshold: {{ current_filters.get('threshold', '10') }}) &times;
                </a>
            {% elif key not in ['sort', 'seed', 'page'] %}
                <a href="{{ url_for('gallery', **generate_url_params(key, None)) }}" class="filter-pill">
                    {{ key }}: {{ value }} &times;
                </a>
            {% endif %}
        {% endfor %}
        <a href="{{ url_for('gallery', sort='random') }}" class="filter-pill clear-all">Clear All</a>
    </div>
    {% endif %}

    <!-- Search by Image Modal -->
    <div id="image-search-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Search by Image</h2>
            <div id="image-drop-zone" class="drop-zone">
                <p>Drag & Drop an image file here, or click to select a file.</p>
                <input type="file" id="file-input" name="search_file">
                <img id="image-preview" src="#" alt="Image Preview" class="hidden"/>
            </div>
            <div class="threshold-container">
                <label for="threshold-slider">Threshold: <span id="threshold-value">10</span></label>
                <input type="range" id="threshold-slider" class="threshold-slider" name="threshold" min="0" max="20" value="10">
            </div>
            <button id="search-button" class="search-button">Search</button>
            <div id="search-status" class="search-status"></div>
        </div>
    </div>

    <!-- Total Images Count -->
    <div class="total-count">
        <span>Total Images: {{ total_artworks }}</span>
    </div>

    <div class="gallery-grid">
        {% for col in range(columns) %}
            <div class="masonry-column">
                {% for art in artworks %}
                    {% if artwork_columns[loop.index0] == col %}
                        <div class="card" id="artwork-{{ art.id }}">
                            <!-- æ ¸å¿ƒæ”¹åŠ¨: æ¢å¤å›¾ç‰‡é“¾æ¥ç»“æ„ -->
                            <a href="{{ url_for('artwork_detail', artwork_id=art.id) }}#page-top" class="card-image-link">
                                {% if config.ENABLE_FULL_RES_CARD_IMAGES %}
                                    <img src="{{ url_for('image_proxy', artwork_id=art.id) }}" 
                                         alt="{{ art.title or art.file_name }}" 
                                         loading="{% if loop.index <= 8 %}eager{% else %}lazy{% endif %}"
                                         {% if loop.index <= 4 %}fetchpriority="high"{% endif %}
                                         decoding="async">
                                {% else %}
                                    <img src="{{ url_for('static', filename='thumbnails/' + (art.thumbnail_filename or 'default.jpg')) }}" 
                                         alt="{{ art.title or art.file_name }}" 
                                         loading="{% if loop.index <= 8 %}eager{% else %}lazy{% endif %}"
                                         {% if loop.index <= 4 %}fetchpriority="high"{% endif %}
                                         decoding="async">
                                {% endif %}
                            </a>
                            {% if art.classification in ['unspecified', 'mature', 'nsfw'] or art.classification is none %}
                                <div class="card-classification">{{ art.classification|title if art.classification else 'Unspecified' }}</div>
                            {% endif %}
                            <div class="card-info">
                                <p class="artist"><a href="{{ url_for('gallery', artist=art.artist) }}">{{ art.artist or 'Unknown' }}</a></p>
                                <p class="title">
                                    <a href="{{ url_for('artwork_detail', artwork_id=art.id) }}#page-top">{{ art.title or 'Untitled' }}</a>
                                </p>
                                <div class="rating-form">
                                    <form action="{{ url_for('rate_artwork', artwork_id=art.id) }}" method="post">
                                        {% for i in range(1, 11) %}
                                            <button type="submit" name="rating" value="{{ i }}" class="{{ 'rated' if art.rating and i <= art.rating }}">
                                                {# è¿™æ˜¯æ ¸å¿ƒæ”¹åŠ¨: æ ¹æ®æ¡ä»¶é€‰æ‹©æ˜Ÿæ˜Ÿå­—ç¬¦ #}
                                                {% if art.rating and i <= art.rating %}â˜…{% else %}â˜†{% endif %}
                                            </button>
                                        {% endfor %}
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    
    {% if not artworks %}
        <p>No artworks found matching your criteria.</p>
    {% endif %}

    <div class="pagination">
        <!-- Prev/Next æŒ‰é’®è¡Œ -->
        <div class="pagination-nav">
            {% if page > 1 %}
                <a href="{{ url_for('gallery', **generate_url_params('page', page - 1)) }}">Â« Prev</a>
            {% endif %}
            {% if page < total_pages %}
                <a href="{{ url_for('gallery', **generate_url_params('page', page + 1)) }}">Next Â»</a>
            {% endif %}
        </div>
        
        <!-- Page è¡¨å•è¡Œ -->
        <form action="{{ url_for('gallery') }}" method="get" class="page-jump-form">
            <span>Page</span>
            <input type="number" name="page" value="{{ page }}" min="1" max="{{ total_pages }}">
            <span>of {{ total_pages }}</span>
            <button type="submit">Go</button>
            <!-- Hidden fields to preserve other filters when jumping pages -->
            {% for key, value in current_filters.items() %}
                {% if key != 'page' %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <input type="hidden" name="sort" value="{{ current_sort }}">
        </form>
    </div>

<script>
//è¶…æ¤­åœ†
function generateSquirclePath(width, height, radius) {
    // å›ºå®šåŠå¾„ï¼Œé¿å…é•¿æ–¹å½¢å˜å½¢
    const r = Math.min(radius, width / 2, height / 2);
    const n = 5; // Apple ä½¿ç”¨çš„è¶…æ¤­åœ†æŒ‡æ•°
    const steps = 30; // å¢åŠ ç‚¹æ•°ä»¥æé«˜å¹³æ»‘åº¦
    
    // è®¡ç®—è¶…æ¤­åœ†å››åˆ†ä¹‹ä¸€åœ†çš„ç‚¹
    function superellipseQuarter() {
        const points = [];
        for (let i = 0; i <= steps; i++) {
            const angle = (i / steps) * (Math.PI / 2);
            // è¶…æ¤­åœ†å…¬å¼ï¼š|x|^n + |y|^n = r^n
            // å‚æ•°åŒ–å½¢å¼ï¼šx = r * cos(t)^(2/n), y = r * sin(t)^(2/n)
            const px = r * Math.pow(Math.cos(angle), 2/n);
            const py = r * Math.pow(Math.sin(angle), 2/n);
            points.push([px, py]);
        }
        return points;
    }
    
    const corner = superellipseQuarter();
    let path = '';
    
    // ä»å·¦ä¸Šè§’åœ†å¼§çš„èµ·ç‚¹å¼€å§‹ (r, 0)ï¼Œé¡ºæ—¶é’ˆç»˜åˆ¶
    path += `M ${r},0`;
    
    // é¡¶éƒ¨ç›´çº¿åˆ°å³ä¸Šè§’
    path += ` L ${width - r},0`;
    
    // å³ä¸Šè§’è¶…æ¤­åœ†ï¼šä» (width-r, 0) åˆ° (width, r)
    for (let i = corner.length - 1; i >= 0; i--) {
        const [px, py] = corner[i];
        path += ` L ${width - r + px},${r - py}`;
    }
    
    // å³ä¾§ç›´çº¿åˆ°å³ä¸‹è§’
    path += ` L ${width},${height - r}`;
    
    // å³ä¸‹è§’è¶…æ¤­åœ†ï¼šä» (width, height-r) åˆ° (width-r, height)
    for (let i = corner.length - 1; i >= 0; i--) {
        const [px, py] = corner[i];
        path += ` L ${width - r + py},${height - r + px}`;
    }
    
    // åº•éƒ¨ç›´çº¿åˆ°å·¦ä¸‹è§’
    path += ` L ${r},${height}`;
    
    // å·¦ä¸‹è§’è¶…æ¤­åœ†ï¼šä» (r, height) åˆ° (0, height-r)
    for (let i = corner.length - 1; i >= 0; i--) {
        const [px, py] = corner[i];
        path += ` L ${r - px},${height - r + py}`;
    }
    
    // å·¦ä¾§ç›´çº¿åˆ°å·¦ä¸Šè§’
    path += ` L 0,${r}`;
    
    // å·¦ä¸Šè§’è¶…æ¤­åœ†ï¼šä» (0, r) åˆ° (r, 0)
    // corner æ˜¯ä» (r, 0) åˆ° (0, r)
    // å˜æ¢å…¬å¼ï¼š(px, py) -> (r-py, r-px)
    for (let i = corner.length - 1; i >= 0; i--) {
        const [px, py] = corner[i];
        path += ` L ${r - py},${r - px}`;
    }
    
    // é—­åˆè·¯å¾„
    path += ' Z';
    return path;
}

// å“åº”å¼ç€‘å¸ƒæµï¼šé¡µé¢åŠ è½½æ—¶æ ¹æ®å±å¹•å®½åº¦åˆ†é…å¡ç‰‡ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const galleryGrid = document.querySelector('.gallery-grid');
    if (!galleryGrid) return;
    
    // æ ‡è®° JavaScript å·²å¯ç”¨
    galleryGrid.classList.add('js-enabled');
    
    // ä¸ºå•ä¸ªå¡ç‰‡åº”ç”¨è¶…æ¤­åœ†çš„å‡½æ•°ï¼ˆæåˆ°å¤–å±‚ä½œç”¨åŸŸï¼‰
    function applySquircleToCard(card, index) {
        const rect = card.getBoundingClientRect();
        const width = Math.round(rect.width);
        const height = Math.round(rect.height);
        const radius = 80;
        
        // åªæœ‰å½“å¡ç‰‡æœ‰å®é™…å°ºå¯¸æ—¶æ‰åº”ç”¨
        if (width === 0 || height === 0) {
            console.log(`âš ï¸ å¡ç‰‡ ${index} å°ºå¯¸ä¸º 0ï¼Œè·³è¿‡`);
            return;
        }
        
        const svgDefs = document.getElementById('squircle-clips');
        const clipId = `squircle-${index}`;
        
        // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤æ—§çš„
        const existingClip = document.getElementById(clipId);
        if (existingClip) {
            existingClip.remove();
        }
        
        // åˆ›å»ºæ–°çš„ clipPath
        const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
        clipPath.setAttribute('id', clipId);
        clipPath.setAttribute('clipPathUnits', 'userSpaceOnUse');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', generateSquirclePath(width, height, radius));
        
        clipPath.appendChild(path);
        svgDefs.appendChild(clipPath);
        
        // åº”ç”¨ clip-path
        const clipPathUrl = `url(#${clipId})`;
        card.style.clipPath = clipPathUrl;
        card.style.webkitClipPath = clipPathUrl;
        
        // æ ‡è®°å·²åº”ç”¨
        card.setAttribute('data-squircle', 'applied');
        card.setAttribute('data-squircle-id', clipId);
        card.setAttribute('data-squircle-size', `${width}x${height}`);
        
        console.log(`âœ… å¡ç‰‡ ${index} è¶…æ¤­åœ†å·²æ›´æ–°: ${width}x${height}`);
    }
    
    // ä¸ºæ‰€æœ‰å¡ç‰‡åº”ç”¨è¶…æ¤­åœ†
    function applySquircleClipPaths() {
        const cards = document.querySelectorAll('.card');
        
        cards.forEach((card, index) => {
            applySquircleToCard(card, index);
        });
        
        console.log(`âœ… åˆå§‹è¶…æ¤­åœ†åº”ç”¨åˆ° ${cards.length} ä¸ªå¡ç‰‡`);
    }
    
    // è®¾ç½®å›¾ç‰‡åŠ è½½ç›‘å¬å™¨çš„å‡½æ•°ï¼ˆåœ¨å¡ç‰‡åˆ†é…åè°ƒç”¨ï¼‰
    function setupImageLoadListeners() {
        const allImages = document.querySelectorAll('.card img');
        console.log(`ğŸ–¼ï¸ æ‰¾åˆ° ${allImages.length} å¼ å›¾ç‰‡ï¼Œå¼€å§‹ç›‘å¬åŠ è½½`);
        
        allImages.forEach((img, imgIndex) => {
            const card = img.closest('.card');
            if (!card) {
                console.log(`âš ï¸ å›¾ç‰‡ ${imgIndex} æ²¡æœ‰æ‰¾åˆ°çˆ¶å¡ç‰‡`);
                return;
            }
            
            // è·å–å¡ç‰‡åœ¨æ‰€æœ‰å¡ç‰‡ä¸­çš„ç´¢å¼•
            const allCards = Array.from(document.querySelectorAll('.card'));
            const cardIndex = allCards.indexOf(card);
            
            // å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°åº”ç”¨è¶…æ¤­åœ†
            const reapplySquircle = () => {
                console.log(`ğŸ”„ å›¾ç‰‡ ${imgIndex} (å¡ç‰‡ ${cardIndex}) åŠ è½½å®Œæˆï¼Œé‡æ–°åº”ç”¨è¶…æ¤­åœ†`);
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿å¸ƒå±€å·²æ›´æ–°
                setTimeout(() => {
                    applySquircleToCard(card, cardIndex);
                }, 100);
            };
            
            if (img.complete && img.naturalHeight !== 0) {
                // å›¾ç‰‡å·²ç»åŠ è½½å®Œæˆ
                console.log(`âœ“ å›¾ç‰‡ ${imgIndex} å·²åŠ è½½å®Œæˆ`);
                reapplySquircle();
            } else {
                // ç›‘å¬å›¾ç‰‡åŠ è½½
                console.log(`â³ å›¾ç‰‡ ${imgIndex} ç­‰å¾…åŠ è½½...`);
                img.addEventListener('load', () => {
                    console.log(`ğŸ“¥ å›¾ç‰‡ ${imgIndex} load äº‹ä»¶è§¦å‘`);
                    reapplySquircle();
                });
                img.addEventListener('error', () => {
                    console.log(`âŒ å›¾ç‰‡ ${imgIndex} åŠ è½½å¤±è´¥`);
                    reapplySquircle();
                });
            }
        });
    }
    
    // è·å–æ‰€æœ‰å¡ç‰‡ï¼ˆä»æ‰€æœ‰åˆ—ä¸­ï¼‰
    const allCards = Array.from(document.querySelectorAll('.masonry-column .card'));
    if (allCards.length === 0) return;
    
    // è·å–å®½é«˜æ¯”æ•°æ®
    const aspectRatios = {{ aspect_ratios | tojson | safe }};
    
    // æ ¹æ®å±å¹•å®½åº¦ç¡®å®šåˆ—æ•°
    function getColumnCount() {
        const width = window.innerWidth;
        if (width <= 600) return 1;
        else if (width <= 900) return 2;
        else if (width <= 1200) return 3;
        else return 4;
    }
    
    // é‡æ–°åˆ†é…å¡ç‰‡åˆ°åˆ—çš„å‡½æ•°
    function redistributeCards() {
        const columnCount = getColumnCount();
        const columns = galleryGrid.querySelectorAll('.masonry-column');
        
        // æ¸…ç©ºæ‰€æœ‰åˆ—
        columns.forEach(col => col.innerHTML = '');
        
        // æ˜¾ç¤º/éšè—åˆ—
        columns.forEach((col, index) => {
            col.style.display = index < columnCount ? 'flex' : 'none';
        });
        
        // åˆå§‹åŒ–åˆ—é«˜åº¦
        const columnHeights = new Array(columnCount).fill(0);
        
        // é‡æ–°åˆ†é…å¡ç‰‡
        allCards.forEach(card => {
            // è·å–å¡ç‰‡çš„ artwork ID
            const artworkId = parseInt(card.id.replace('artwork-', ''));
            const aspectRatio = aspectRatios[artworkId] || 1.0;
            const cardHeight = 1.0 / aspectRatio + 0.3;
            
            // æ‰¾åˆ°æœ€çŸ­çš„åˆ—
            const minColIndex = columnHeights.indexOf(Math.min(...columnHeights));
            
            // å°†å¡ç‰‡æ·»åŠ åˆ°è¯¥åˆ—
            columns[minColIndex].appendChild(card.cloneNode(true));
            
            // æ›´æ–°åˆ—é«˜åº¦
            columnHeights[minColIndex] += cardHeight;
        });
        
        // å¡ç‰‡é‡æ–°åˆ†é…å®Œæˆåï¼Œåªè®¾ç½®å›¾ç‰‡åŠ è½½ç›‘å¬ï¼ˆä¸ç«‹å³åº”ç”¨è¶…æ¤­åœ†ï¼‰
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                console.log('ğŸ–¼ï¸ è®¾ç½®å›¾ç‰‡åŠ è½½ç›‘å¬...');
                setupImageLoadListeners();
            });
        });
    }
    
    // åˆå§‹åˆ†é…
    redistributeCards();
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    let resizeTimer;
    window.addEventListener('resize', () => {
        // é˜²æŠ–ï¼šç­‰å¾…ç”¨æˆ·åœæ­¢è°ƒæ•´çª—å£å¤§å°åå†é‡æ–°å¸ƒå±€
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            console.log('ğŸ“ çª—å£å¤§å°æ”¹å˜ï¼Œé‡æ–°å¸ƒå±€...');
            redistributeCards();
        }, 300); // 300ms é˜²æŠ–å»¶è¿Ÿ
    });
    
    // iOS è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å‘æ—¶æ˜¾ç¤ºï¼‰
    // å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šä»¥å¯ç”¨è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
    /*
    setTimeout(() => {
        const debugInfo = document.createElement('div');
        debugInfo.style.cssText = 'position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 12px; z-index: 9999; max-width: 300px;';
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const cards = document.querySelectorAll('.card');
        const appliedCount = document.querySelectorAll('.card[data-clip-verified="yes"]').length;
        const failedCount = document.querySelectorAll('.card[data-clip-verified="no"]').length;
        const method = document.querySelector('.card[data-method]')?.getAttribute('data-method') || 'unknown';
        
        debugInfo.innerHTML = `
            <strong>ğŸ” è¶…æ¤­åœ†è°ƒè¯•</strong><br>
            è®¾å¤‡: ${isIOS ? 'iOS' : 'éiOS'}<br>
            æµè§ˆå™¨: ${isSafari ? 'Safari' : 'å…¶ä»–'}<br>
            æ–¹æ³•: ${method}<br>
            æ€»å¡ç‰‡: ${cards.length}<br>
            æˆåŠŸ: ${appliedCount}<br>
            å¤±è´¥: ${failedCount}
        `;
        
        document.body.appendChild(debugInfo);
        
        // ç‚¹å‡»å…³é—­
        debugInfo.addEventListener('click', () => debugInfo.remove());
    }, 500);
    */
});
</script>

{% endblock %}
