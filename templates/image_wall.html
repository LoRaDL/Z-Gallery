{% extends "layout.html" %}
{% block content %}
<style>
    /* 瀑布流布局：每列独立垂直排列 */
    .gallery-grid {
        display: flex !important;
        padding: 20px;
        align-items: flex-start !important;
        width: 100%;
        box-sizing: border-box;
    }
    
    .masonry-column {
        flex: 1 1 0; /* 每列等宽 */
        min-width: 0; /* 防止flex子元素溢出 */
        display: flex;
        flex-direction: column;
    }
    
    /* 卡片不需要额外的margin */
    .gallery-grid .card {
        margin-bottom: 0 !important;
        break-inside: avoid; /* 防止卡片被分割 */
    }
    
    /* 图片自然高度显示 */
    .gallery-grid .card-image-link {
        display: block;
        overflow: hidden;
        width: 100%;
    }
    
    .gallery-grid .card-image-link img {
        width: 100%;
        max-width: 100%;
        height: auto;
        display: block;
        background-color: #f0f0f0; /* 加载前的占位背景 */
    }
    
    /* NSFW/MATURE图片模糊处理 */
    .gallery-grid .card-image-link img.blur-image {
        filter: blur(5px);
        transition: filter 0.3s;
    }
    
    .gallery-grid .card-image-link:hover img.blur-image {
        filter: blur(0);
    }
    
    /* 确保卡片不溢出 */
    .gallery-grid .card {
        width: 100%;
        box-sizing: border-box;
    }
    

</style>

<div class="controls-container">
    <!-- Sort Group -->
    <span class="filter-label">Sort:</span>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('sort', 'newest')) }}" class="{{ 'active' if current_sort == 'newest' }}">Newest</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('sort', 'oldest')) }}" class="{{ 'active' if current_sort == 'oldest' }}">Oldest</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('sort', 'latest_added')) }}" class="{{ 'active' if current_sort == 'latest_added' }}">Latest Added</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('sort', 'rating')) }}" class="{{ 'active' if current_sort == 'rating' }}">Rating</a>

    <span class="separator">|</span>

    <!-- Classification Group -->
    <span class="filter-label">Class:</span>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('classification_filter', 'unspecified')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'unspecified' }}">Unspecified</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('classification_filter', 'sfw')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'sfw' }}">SFW</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('classification_filter', 'mature')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'mature' }}">Mature</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('classification_filter', 'nsfw')) }}" class="{{ 'active' if current_filters.get('classification_filter') == 'nsfw' }}">NSFW</a>

    <span class="separator">|</span>

    <!-- Category Group -->
    <span class="filter-label">Category:</span>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('category', 'fanart_non_comic')) }}" class="{{ 'active' if current_filters.get('category') == 'fanart_non_comic' }}">Art</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('category', 'fanart_comic')) }}" class="{{ 'active' if current_filters.get('category') == 'fanart_comic' }}">Comic</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('category', 'real_photo')) }}" class="{{ 'active' if current_filters.get('category') == 'real_photo' }}">Photo</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('category', 'other')) }}" class="{{ 'active' if current_filters.get('category') == 'other' }}">Other</a>

    <span class="separator">|</span>

    <!-- Rating Group -->
    <span class="filter-label">Rating:</span>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('rating_filter', 'unrated')) }}" class="{{ 'active' if current_filters.get('rating_filter') == 'unrated' }}">Unrated</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('rating_filter', '2_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '2_plus' }}">2★+</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('rating_filter', '5_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '5_plus' }}">5★+</a>
    <a href="{{ mode_url_for('image_wall', **generate_url_params('rating_filter', '8_plus')) }}" class="{{ 'active' if current_filters.get('rating_filter') == '8_plus' }}">8★+</a>

    <span class="separator">|</span>

    <!-- Columns Control -->
    <span class="filter-label">Columns:</span>
    {% set columns_params = current_filters.copy() %}
    {% set _ = columns_params.update({'columns': 2}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 2 }}">2</a>
    {% set _ = columns_params.update({'columns': 3}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 3 }}">3</a>
    {% set _ = columns_params.update({'columns': 4}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 4 }}">4</a>
    {% set _ = columns_params.update({'columns': 5}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 5 }}">5</a>
    {% set _ = columns_params.update({'columns': 6}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 6 }}">6</a>
    {% set _ = columns_params.update({'columns': 8}) %}
    <a href="{{ mode_url_for('image_wall', **columns_params) }}" class="{{ 'active' if columns == 8 }}">8</a>
</div>

    {% if current_filters %}
    <div class="active-filters">
        <span>Active Filters:</span>
        {% for key, value in current_filters.items() %}
            {% if key == 'similar_to' %}
                <a href="{{ mode_url_for('image_wall', **generate_url_params(key, None)) }}" class="filter-pill">
                    Similar Images (Threshold: {{ current_filters.get('threshold', '10') }}) &times;
                </a>
            {% elif key not in ['sort', 'seed', 'columns'] %}
                <a href="{{ mode_url_for('image_wall', **generate_url_params(key, None)) }}" class="filter-pill">
                    {{ key }}: {{ value }} &times;
                </a>
            {% endif %}
        {% endfor %}
        <a href="{{ mode_url_for('image_wall', sort='random', columns=columns) }}" class="filter-pill clear-all">Clear All</a>
    </div>
    {% endif %}

    <!-- Search by Image Modal -->
    <div id="image-search-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Search by Image</h2>
            <div id="image-drop-zone" class="drop-zone">
                <p>Drag & Drop an image file here, or click to select a file.</p>
                <input type="file" id="file-input" name="search_file">
                <img id="image-preview" src="#" alt="Image Preview" class="hidden"/>
            </div>
            <div class="threshold-container">
                <label for="threshold-slider">Threshold: <span id="threshold-value">10</span></label>
                <input type="range" id="threshold-slider" class="threshold-slider" name="threshold" min="0" max="20" value="10">
            </div>
            <button id="search-button" class="search-button">Search</button>
            <div id="search-status" class="search-status"></div>
        </div>
    </div>

    <!-- Total Images Count -->
    <div class="total-count">
        <span>Total Images: {{ total_artworks }}</span>
    </div>

    <div class="gallery-grid" id="gallery-grid">
        {% for col in range(columns) %}
            <div class="masonry-column" data-column="{{ col }}">
                <!-- 卡片将由 JavaScript 动态加载 -->
            </div>
        {% endfor %}
    </div>

    <!-- 隐藏的卡片数据，供 JavaScript 使用 -->
    <script type="application/json" id="artworks-data">
    [
        {% for art in artworks %}
        {
            "id": {{ art.id }},
            "title": {{ (art.title or 'Untitled')|tojson }},
            "artist": {{ (art.artist or 'Unknown')|tojson }},
            "file_name": {{ art.file_name|tojson }},
            "thumbnail_filename": {{ (art.thumbnail_filename or 'default.jpg')|tojson }},
            "classification": {{ (art.classification or 'unspecified')|tojson }},
            "rating": {{ art.rating or 0 }},
            "column": {{ artwork_columns[loop.index0] }},
            "aspect_ratio": {{ aspect_ratios.get(art.id, 1.0) }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
    
    {% if not artworks %}
        <p>No artworks found matching your criteria.</p>
    {% endif %}

    <!-- 滚动位置指示器 -->
    <div id="scroll-indicator">
        <span id="current-image">0</span>
    </div>
    
    <!-- 底部padding，让所有图片可以划出屏幕 -->
    <div style="height: 100vh;"></div>

<script>
// 虚拟滚动和滚动位置指示器
document.addEventListener('DOMContentLoaded', function() {
    // Mode detection for URL generation
    const isPrivate = {{ 'true' if is_private else 'false' }};
    const modeUrlPrefix = isPrivate ? '/private' : '/public';
    
    // 虚拟滚动配置
    const BUFFER_SIZE = 50; // 视口外缓冲区大小（每个方向）
    const CARD_ESTIMATE_HEIGHT = 300; // 估算卡片高度（用于初始计算）
    
    // 获取数据
    const artworksData = JSON.parse(document.getElementById('artworks-data').textContent);
    const galleryGrid = document.getElementById('gallery-grid');
    const columnsCount = parseInt('{{ columns }}');
    
    // 按列分组数据
    const columnData = Array.from({ length: columnsCount }, () => []);
    artworksData.forEach(art => {
        columnData[art.column].push(art);
    });
    
    // 虚拟滚动状态
    const virtualState = {
        visibleRanges: Array.from({ length: columnsCount }, () => ({ start: 0, end: 0 })),
        renderedCards: new Set(),
        cardElements: new Map(),
        columnElements: [],
        cardHeights: new Map(), // 缓存实际卡片高度
        estimatedPositions: Array.from({ length: columnsCount }, () => []) // 每列的估算位置
    };
    
    // 初始化列元素
    virtualState.columnElements = Array.from(galleryGrid.querySelectorAll('.masonry-column'));
    
    // 应用动态样式
    function applyDynamicStyles() {
        const scaleFactor = columnsCount / 4;
        const gap = (1.5 / scaleFactor).toFixed(2);
        const fontSize = {
            button: (1.2 / scaleFactor).toFixed(2),
            artist: (0.9 / scaleFactor).toFixed(2),
            title: (0.85 / scaleFactor).toFixed(2),
            classification: (0.7 / scaleFactor).toFixed(2)
        };
        const padding = {
            button: `${(0.2 / scaleFactor).toFixed(2)}rem ${(0.3 / scaleFactor).toFixed(2)}rem`,
            classification: `${(0.2 / scaleFactor).toFixed(2)}rem ${(0.4 / scaleFactor).toFixed(2)}rem`,
            cardInfo: (0.75 / scaleFactor).toFixed(2),
            margin: (0.25 / scaleFactor).toFixed(2)
        };
        
        const style = document.createElement('style');
        style.textContent = `
            .gallery-grid { gap: ${gap}rem !important; }
            .masonry-column { gap: ${gap}rem !important; }
            .gallery-grid .rating-form button { 
                font-size: ${fontSize.button}rem !important; 
                padding: ${padding.button} !important; 
            }
            .gallery-grid .card-info .artist { font-size: ${fontSize.artist}rem !important; }
            .gallery-grid .card-info .title { font-size: ${fontSize.title}rem !important; }
            .gallery-grid .card-classification { 
                font-size: ${fontSize.classification}rem !important; 
                padding: ${padding.classification} !important; 
            }
            .gallery-grid .card-info { padding: ${padding.cardInfo}rem !important; }
            .gallery-grid .card-info p { margin: ${padding.margin}rem 0 !important; }
            .gallery-grid .card { border-radius: ${(24 / scaleFactor).toFixed(2)}px !important; }
            .gallery-grid .card-image-link img { border-radius: ${(0 / scaleFactor).toFixed(2)}px !important; }
        `;
        document.head.appendChild(style);
    }
    
    applyDynamicStyles();
    
    // 计算每列的估算位置（使用后端预计算的宽高比）
    function calculateEstimatedPositions() {
        // 动态计算实际卡片宽度
        const galleryWidth = galleryGrid.offsetWidth - 40; // 减去padding
        const gap = parseFloat(getComputedStyle(galleryGrid).gap) || 20;
        const cardWidth = (galleryWidth - gap * (columnsCount - 1)) / columnsCount;
        
        for (let col = 0; col < columnsCount; col++) {
            const positions = [];
            let currentHeight = 0;
            
            columnData[col].forEach((art, index) => {
                positions.push(currentHeight);
                // 使用实际卡片宽度和宽高比计算高度
                const aspectRatio = art.aspect_ratio || 1.0;
                const imageHeight = cardWidth / aspectRatio;
                const cardInfoHeight = 80; // 卡片信息区域高度
                const cardHeight = imageHeight + cardInfoHeight;
                const cardGap = 20; // 卡片间距
                
                currentHeight += cardHeight + cardGap;
            });
            
            virtualState.estimatedPositions[col] = positions;
        }
    }
    
    // 创建卡片元素
    function createCardElement(art) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        cardDiv.id = `artwork-${art.id}`;
        cardDiv.dataset.artworkId = art.id;
        
        const blurClass = art.classification === 'nsfw' ? ' blur-image' : '';
        const aspectStyle = art.aspect_ratio ? `style="aspect-ratio: ${art.aspect_ratio};"` : '';
        
        let classificationDiv = '';
        if (['unspecified', 'mature', 'nsfw'].includes(art.classification)) {
            const displayClass = art.classification === 'unspecified' ? 'Unspecified' : 
                                art.classification.charAt(0).toUpperCase() + art.classification.slice(1);
            classificationDiv = `<div class="card-classification">${displayClass}</div>`;
        }
        
        let ratingButtons = '';
        for (let i = 1; i <= 10; i++) {
            const isRated = art.rating && i <= art.rating;
            const ratedClass = isRated ? ' rated' : '';
            const star = isRated ? '★' : '☆';
            if (isPrivate) {
                ratingButtons += `<button type="submit" name="rating" value="${i}" class="${ratedClass}">${star}</button>`;
            } else {
                ratingButtons += `<span class="star${ratedClass}">${star}</span>`;
            }
        }
        
        cardDiv.innerHTML = `
            <a href="${modeUrlPrefix}/artwork/${art.id}#page-top" class="card-image-link">
                <img src="/static/thumbnails/${art.thumbnail_filename}" 
                     alt="${art.title}" 
                     loading="lazy"
                     class="${blurClass}"
                     ${aspectStyle}>
            </a>
            ${classificationDiv}
            <div class="card-info">
                <p class="artist"><a href="${modeUrlPrefix}/image-wall?artist=${encodeURIComponent(art.artist)}&columns=${columnsCount}">${art.artist}</a></p>
                <p class="title">
                    <a href="${modeUrlPrefix}/artwork/${art.id}#page-top">${art.title}</a>
                </p>
                <div class="rating-form">
                    ${isPrivate ? `<form action="${modeUrlPrefix}/rate/${art.id}" method="post">
                        ${ratingButtons}
                    </form>` : `<div class="rating-display">
                        ${ratingButtons}
                        <span class="rating-value">(${art.rating || 'Unrated'}/10)</span>
                    </div>`}
                </div>
            </div>
        `;
        
        // 为新创建的卡片绑定评分事件（使用公共函数）
        const ratingForm = cardDiv.querySelector('.rating-form form');
        if (ratingForm && window.setupRatingHandler) {
            window.setupRatingHandler(ratingForm);
        }
        
        return cardDiv;
    }
    
    // 更新可见范围 - 基于实际DOM位置
    function updateVisibleRanges() {
        const scrollTop = window.scrollY;
        const viewportHeight = window.innerHeight;
        const buffer = viewportHeight * 2;
        
        const loadThreshold = scrollTop + viewportHeight + buffer;
        
        for (let col = 0; col < columnsCount; col++) {
            const columnData_col = columnData[col];
            const columnElement = virtualState.columnElements[col];
            
            if (!columnData_col || columnData_col.length === 0 || !columnElement) {
                continue;
            }
            
            const currentRange = virtualState.visibleRanges[col];
            
            // 检查是否需要加载更多
            // 方法1：检查列的底部位置
            const columnRect = columnElement.getBoundingClientRect();
            const columnBottom = scrollTop + columnRect.bottom;
            
            if (columnBottom < loadThreshold && currentRange.end < columnData_col.length) {
                // 需要加载更多，一次加载一批
                const batchSize = Math.min(20, columnData_col.length - currentRange.end);
                virtualState.visibleRanges[col] = {
                    start: currentRange.start,
                    end: currentRange.end + batchSize
                };
            }
        }
    }
    
    // 渲染可见卡片 - 只向下加载，上方保持
    function renderVisibleCards() {
        for (let col = 0; col < columnsCount; col++) {
            const range = virtualState.visibleRanges[col];
            const columnElement = virtualState.columnElements[col];
            
            // 只添加新的卡片，不移除已有的
            for (let i = range.start; i < range.end; i++) {
                const art = columnData[col][i];
                const cardId = `artwork-${art.id}`;
                
                if (!virtualState.renderedCards.has(cardId)) {
                    // 创建新卡片
                    const cardElement = createCardElement(art);
                    virtualState.cardElements.set(cardId, cardElement);
                    columnElement.appendChild(cardElement);
                    virtualState.renderedCards.add(cardId);
                    
                    // 缓存实际高度
                    setTimeout(() => {
                        const rect = cardElement.getBoundingClientRect();
                        virtualState.cardHeights.set(cardId, rect.height);
                    }, 0);
                }
            }
        }
    }
    
    // 初始化虚拟滚动
    function initVirtualScroll() {
        calculateEstimatedPositions();
        
        // 初始化时显示每列的前几个卡片
        for (let col = 0; col < columnsCount; col++) {
            const initialCount = Math.min(15, columnData[col].length); // 每列显示前15个
            virtualState.visibleRanges[col] = { start: 0, end: initialCount };
        }
        
        renderVisibleCards();
        updateScrollIndicator();
    }
    
    // 滚动事件处理
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            updateVisibleRanges();
            renderVisibleCards();
            updateScrollIndicator(); // 添加滚动指示器更新
        }, 16); // ~60fps
    }
    
    // 窗口大小变化处理
    function handleResize() {
        calculateEstimatedPositions();
        updateVisibleRanges();
        renderVisibleCards();
    }
    
    // 滚动位置指示器逻辑（适配虚拟滚动）
    const indicator = document.getElementById('scroll-indicator');
    const currentImageSpan = document.getElementById('current-image');
    const totalCards = artworksData.length;
    
    // 滚动指示器：基于用户滚动位置计算看过的图片数量
    function updateScrollIndicator() {
        if (!currentImageSpan || !indicator) return; // 防护检查
        
        const scrollTop = window.scrollY;
        const viewportBottom = scrollTop + window.innerHeight;
        
        // 基于实际DOM元素计算看过的卡片数量
        let viewedCount = 0;
        
        // 遍历所有已渲染的卡片
        virtualState.renderedCards.forEach(cardId => {
            const cardElement = virtualState.cardElements.get(cardId);
            if (cardElement) {
                const cardRect = cardElement.getBoundingClientRect();
                const cardTop = scrollTop + cardRect.top;
                
                // 如果卡片顶部在视口底部以上，说明用户看过了
                if (cardTop <= viewportBottom) {
                    viewedCount++;
                }
            }
        });
        
        currentImageSpan.textContent = Math.min(viewedCount, totalCards);
        
        // 动画效果
        const documentHeight = document.documentElement.scrollHeight;
        const viewportHeight = window.innerHeight;
        const maxScroll = documentHeight - viewportHeight;
        
        if (maxScroll <= 0) return; // 防止除零错误
        
        const distanceToPageBottom = maxScroll - scrollTop;
        const animationRange = viewportHeight * 3;
        const progress = Math.max(0, Math.min(1, 1 - (distanceToPageBottom / animationRange)));
        
        const scale = 1 + progress;
        const bgOpacity = 0.8 * (1 - progress);
        const bottomValue = 20 + (50 - 20) * progress;
        
        indicator.style.bottom = `${bottomValue}%`;
        indicator.style.transform = `translate(-50%, 50%) scale(${scale})`;
        indicator.style.background = `rgba(0, 0, 0, ${bgOpacity})`;
        indicator.style.boxShadow = bgOpacity > 0 ? `0 4px 12px rgba(0, 0, 0, ${bgOpacity * 0.375})` : 'none';
        
        // 显示指示器
        if (!indicator.style.opacity || indicator.style.opacity === '0') {
            indicator.style.opacity = '1';
        }
    }
    
    // 绑定事件
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleResize, { passive: true });
    
    // 初始化
    initVirtualScroll();
    
    // 初始化指示器
    updateScrollIndicator();
});
</script>

<style>
#scroll-indicator {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 20px 40px;
    border-radius: 30px;
    font-size: 3rem;
    font-weight: bold;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    pointer-events: none;
    /* 初始隐藏，等待布局完成 */
    opacity: 0;
    /* 更长的平滑时间：0.5秒，ease-out让动画快速开始然后平滑结束 */
    transition: transform 0.5s ease-out, 
                bottom 0.5s ease-out, 
                background 0.5s ease-out, 
                box-shadow 0.5s ease-out,
                opacity 0.3s ease-out;
}

#scroll-indicator #current-image {
    color: #4CAF50;
    font-size: 3.6rem;
}
</style>

{% endblock %}
